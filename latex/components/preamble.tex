% Layout
\usepackage[a4paper,top=2cm,bottom=2cm]{geometry}
\usepackage[colorlinks]{hyperref}
% \usepackage[allbordercolors={1 0 0}]{hyperref}
% \usepackage[hidelinks]{hyperref}
\usepackage{lastpage}       % ``n of m'' page numbering
\usepackage{pdflscape} % to allow some pages to be landscaped, with \begin{landscape}
\usepackage{parskip}
\usepackage{multicol}
\usepackage{caption}  % for manual captions within multicol

% File management
\usepackage{subfiles}
\usepackage{zref-xr} % for references to labels across subfiles

% Font
\usepackage[normalem]{ulem} % strikethrough
\usepackage[soul]{lua-ul} % for highlighting via \hl and underline via \ul. LuaLaTeX version of soul courtesy of https://tex.stackexchange.com/a/586053
\usepackage{luacolor}  % LuaLaTeX version of soul courtesy of https://tex.stackexchange.com/a/586053


% Figures
\usepackage{float}

% Tables
% General advice for tabulars: wrapping them with \resizebox is BAD practice because it results in inconsistent font sizes across tables! https://tex.stackexchange.com/a/600094
% \usepackage{booktabs}
\usepackage{longtable}
\usepackage{tabularray}
\usepackage{ninecolors}
\NineColors{saturation=high}
\UseTblrLibrary{booktabs}
\DefTblrTemplate{contfoot-text}{default}{\emph{continued on next page\dots}}
\DefTblrTemplate{conthead-text}{default}{(continued)}
\newenvironment{longtabse}[3][]
{
    \dtldiv{\newheavyrulewidth}{.08}{#3}  % default is .08em
    \dtldiv{\newlightrulewidth}{.05}{#3}  % default is .05em
    \dtldiv{\newcmidrulewidth}{.03}{#3}  % default is .03em
    \dtldiv{\newbelowrulesep}{.65}{#3}  % default is .65ex
    \dtldiv{\newaboverulesep}{.4}{#3}  % default is .4ex, fine-tuned to .65ex
    \dtldiv{\newdefaultaddspace}{.5}{#3}  % default is .5em
    \dtldiv{\newrulesep}{2}{#3}  % default is 2pt
    \dtldiv{\newstretch}{1}{#3}  % default is 1
    \dtldiv{\newabovesep}{2}{#3}  % default is 2pt  % ! NO EFFECT IN BOOKTABS
    \dtldiv{\newbelowsep}{2}{#3}  % default is 2pt  % ! NO EFFECT IN BOOKTABS
    \dtldiv{\newrowsep}{2}{#3}  % default is 2pt  % ! NO EFFECT IN BOOKTABS
    \dtldiv{\newleftsep}{6}{#3}  % default is 6pt
    \dtldiv{\newrightsep}{6}{#3}  % default is 6pt
    \dtldiv{\newcolsep}{6}{#3}  % default is 6pt
    % \dtldiv{\newfontsize}{10}{#3}  % default is 10pt
    % \dtldiv{\newbaselineskip}{15}{#3}  % default is 12pt, fine-tuned to 15
    \dtldiv{\newinversescale}{1}{#3}  % helper value for \adjustbox's scale factor
    \dtldiv{\newcelltoppadding}{1.55}{#3}  % helper value for \adjustbox's margin
    \dtldiv{\newcellbottompadding}{1.4}{#3}  % helper value for \adjustbox's margin

    \heavyrulewidth=\newheavyrulewidth em
    \lightrulewidth=\newlightrulewidth em
    \cmidrulewidth=\newcmidrulewidth em
    \belowrulesep=\newbelowrulesep ex
    \aboverulesep=\newaboverulesep ex
    \defaultaddspace=\newdefaultaddspace em
    \begin{longtabs}[#1]{
        #2\relax,
        rows={valign=m},  % handled by \adjustbox{stack=cc,...}
        % cells={preto=\adjustbox{stack=cc,scale=\newinversescale}\bgroup,appto=\egroup},  % also works
        % cells={cmd=\adjustbox{stack=cc,padding={0 ex} {\newcellbottompadding ex} {0 ex} {\newcelltoppadding ex}, scale=\newinversescale}},
        cells={font=\scalefont{\newinversescale}},
        vspan=even,
        rulesep=\newrulesep pt,
        stretch=\newstretch,
        abovesep=\newabovesep pt,  % ! NO EFFECT IN BOOKTABS
        belowsep=\newbelowsep pt,  % ! NO EFFECT IN BOOKTABS
        rowsep=\newrowsep pt,  % ! NO EFFECT IN BOOKTABS, DEFAULT IS 0pt
        leftsep=\newleftsep pt,
        rightsep=\newrightsep pt,
        colsep=\newcolsep pt,
    }
}
{
    \end{longtabs}
}

% Colours
\usepackage{xcolor}
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codebg}{rgb}{0.96, 0.96, 0.96}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{codered}{rgb}{1, 0.9, 0.9}
\newcommand{\textorange}[1]{\textcolor{orange}{#1}}
\newcommand{\textred}[1]{\textcolor{red}{#1}}
\newcommand{\exception}[1]{\textcolor{red}{\textbf{\hl{#1}}}}
\newcommand{\exceptiong}[1]{\textcolor{red}{\textbf{\phantom{あ}\hl{#1}\phantom{あ}}}}  % g for guard
\usepackage{microtype}  % required for \textls, hacky solution for furigana
\newcommand{\textwhite}[1]{\textcolor{white}{#1}}
\newcommand{\textblue}[1]{\textcolor{blue}{#1}}
\newcommand{\textgreen}[1]{\textcolor{codegreen}{#1}}
\newcommand{\textpurple}[1]{\textcolor{codepurple}{#1}}
\newcommand{\textlightgrey}[1]{\textcolor{lightgray}{#1}}
\newcommand{\textgrey}[1]{\textcolor{gray}{#1}}
\newcommand{\textblack}[1]{\textcolor{black}{#1}}

% Basic LaTeX structures
\usepackage{enumitem} % For custom enumerate

% Description Labels
% Coutesy of https://tex.stackexchange.com/a/1248
\makeatletter
\let\orgdescriptionlabel\descriptionlabel
\renewcommand*{\descriptionlabel}[1]{%
    \let\orglabel\label
    \let\label\@gobble
    \phantomsection
    \edef\@currentlabel{#1\unskip}%
    %\edef\@currentlabelname{#1}%
    \let\label\orglabel
    \orgdescriptionlabel{#1}%
}
\makeatother

% Miscellaneous
\usepackage{pxrubrica}  % Support for ふりがな
\rubysetup{j}  % Jukugo ruby by default, use | to separate word boundaries if available
\usepackage{siunitx}
\usepackage{nicefrac}
\usepackage{amssymb}  % for \lessapprox
\usepackage{cancel}
\newcommand{\aux}{\textsc{aux}}
\newcommand{\prefix}{\textsc{prefix}}
\newcommand{\suffix}{\textsc{suffix}}
\newcommand{\conjunction}{\textsc{conjunction}}
\newcommand{\htc}{\textsc{\textbf{HTC}}}
\usepackage{tikz}
\usetikzlibrary{patterns}
\usepackage[no-test-for-array]{nicematrix}  % no-test-for-array is a hack to allow the Docker image to run successfully; this is necessary with the use of nicematrix package
\newcommand{\viteq}{\Block[transparent, tikz={pattern = crosshatch, pattern color = gray!10}]{1-*}{}}
\newcommand{\vit}{\Block[transparent, tikz={pattern = grid, pattern color = gray!10}]{1-*}{}}
\usepackage{centernot}
\usepackage{stmaryrd}  % for \shortrightarrow
\usepackage[math=fp]{datatool-base}  % LaTeX arithmetic courtesy of https://www.dickimaw-books.com/latex/admin/html/arithmetic.shtml
\usepackage{adjustbox}
\usepackage{relsize}
\usepackage{scalefnt}
\usepackage{fontsize}
\usepackage[regular]{newcomputermodern}

% Rename sections for \documentclass{ltjarticle}
% \renewcommand{\figurename}{Figure} % ltjarticle overrides this to
\renewcommand{\tablename}{Table} % ltjarticle overrides this to 表 (ひょう)
\renewcommand{\contentsname}{Contents} % ltjarticle overrides this to 表 (ひょう)

% Heading
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\lhead{\textbf{ジャッキー・カン}\\kung.jwe@gmail.com}
\rhead{\textbf{日本語\ruby{学習}{がく|しゅう}\ruby{教材}{きょう|ざい}}}
% \rhead{\textbf{日本語\ruby{学習}{ガク|シュウ}\ruby{教材}{キョウ|ザイ}}}
% Date formatting courtesy of https://tex.stackexchange.com/a/638289
\usepackage{datetime2}
\DTMnewstyle{myformat}{
    \renewcommand*\DTMdisplay[9]{
        \DTMtwodigits{##1}\DTMtwodigits{##2}\DTMtwodigits{##3} \DTMtwodigits{##5}\DTMtwodigits{##6}\DTMtwodigits{##7}
    }
}{}{}{}
\ifcsname currentdatestring\endcsname
    \chead{\textlightgrey{\currentdatestring}}
\else
    \chead{\textlightgrey{\DTMsetstyle{myformat} \DTMnow}}
\fi
\setlength{\headheight}{28pt}  % Adjust according to compilation warnings
\cfoot{Page \thepage\ of \pageref{LastPage}}
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\footrulewidth}{0.5pt}
