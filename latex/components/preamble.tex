% Layout
\usepackage[a4paper,top=2cm,bottom=2cm]{geometry}
\usepackage[colorlinks]{hyperref}
% \usepackage[allbordercolors={1 0 0}]{hyperref}
% \usepackage[hidelinks]{hyperref}
\usepackage{lastpage}  % ``n of m'' page numbering
\usepackage{pdflscape}  % to allow some pages to be landscaped, with \begin{landscape}
\usepackage{parskip}
\usepackage{caption}  % for manual captions within multicol

% File management
\usepackage{subfiles}
\usepackage{zref-xr} % for references to labels across subfiles

% Font
\usepackage[normalem]{ulem} % strikethrough
\usepackage[soul]{lua-ul} % for highlighting via \hl and underline via \ul. LuaLaTeX version of soul courtesy of https://tex.stackexchange.com/a/586053
\usepackage{luacolor}  % LuaLaTeX version of soul courtesy of https://tex.stackexchange.com/a/586053

% Figures
\usepackage{float}

% Colours
% \usepackage{xcolor}
\usepackage{ninecolors}
\NineColors{saturation=high}
\newcommand{\textorange}[1]{\textcolor{brown7}{#1}}
\newcommand{\textred}[1]{\textcolor{red5}{#1}}
\newcommand{\exception}[1]{\textcolor{red5}{\textbf{\hl{#1}}}}
\newcommand{\exceptiong}[1]{\textcolor{red5}{\textbf{\phantom{あ}\hl{#1}\phantom{あ}}}}  % g for guard
\usepackage{microtype}  % required for \textls, hacky solution for furigana
\newcommand{\textwhite}[1]{\textcolor{white}{#1}}
\newcommand{\textblue}[1]{\textcolor{blue5}{#1}}
\newcommand{\textgreen}[1]{\textcolor{green5}{#1}}
\newcommand{\textpurple}[1]{\textcolor{violet5}{#1}}
\newcommand{\textlightgrey}[1]{\textcolor{lightgray}{#1}}
\newcommand{\textgrey}[1]{\textcolor{gray}{#1}}
\newcommand{\textblack}[1]{\textcolor{black}{#1}}

% Tables
% General advice for tabulars: wrapping them with \resizebox is BAD practice because it results in inconsistent font sizes across tables! https://tex.stackexchange.com/a/600094
\usepackage{tabularray}
\UseTblrLibrary{booktabs}
\DefTblrTemplate{contfoot-text}{default}{\emph{continued on next page\dots}}
\DefTblrTemplate{conthead-text}{default}{(continued)}
\newenvironment{longtabse}[3][]
{
    \dtldiv{\newheavyrulewidth}{.08}{#3}  % default is .08em
    \dtldiv{\newlightrulewidth}{.05}{#3}  % default is .05em
    \dtldiv{\newcmidrulewidth}{.03}{#3}  % default is .03em
    \dtldiv{\newbelowrulesep}{.65}{#3}  % default is .65ex
    \dtldiv{\newaboverulesep}{.4}{#3}  % default is .4ex, fine-tuned to .65ex
    \dtldiv{\newdefaultaddspace}{.5}{#3}  % default is .5em
    \dtldiv{\newrulesep}{2}{#3}  % default is 2pt
    \dtldiv{\newstretch}{1}{#3}  % default is 1
    \dtldiv{\newabovesep}{2}{#3}  % default is 2pt
    \dtldiv{\newbelowsep}{2}{#3}  % default is 2pt
    \dtldiv{\newrowsep}{2}{#3}  % default is 2pt
    \dtldiv{\newleftsep}{6}{#3}  % default is 6pt
    \dtldiv{\newrightsep}{6}{#3}  % default is 6pt
    \dtldiv{\newcolsep}{6}{#3}  % default is 6pt
    \dtldiv{\newinversescale}{1}{#3}  % helper value for \adjustbox's scale factor
    \dtldiv{\newcelltoppadding}{1.55}{#3}  % helper value for \adjustbox's margin
    \dtldiv{\newcellbottompadding}{1.4}{#3}  % helper value for \adjustbox's margin

    \heavyrulewidth=\newheavyrulewidth em
    \lightrulewidth=\newlightrulewidth em
    \cmidrulewidth=\newcmidrulewidth em
    \belowrulesep=\newbelowrulesep ex
    \aboverulesep=\newaboverulesep ex
    \defaultaddspace=\newdefaultaddspace em
    \begin{longtabs}[#1]{
        rows={valign=m},
        cells={font=\scalefont{\newinversescale}},
        vspan=even,
        rulesep=\newrulesep pt,
        stretch=\newstretch,
        abovesep=\newabovesep pt,
        belowsep=\newbelowsep pt,
        rowsep=\newrowsep pt,
        leftsep=\newleftsep pt,
        rightsep=\newrightsep pt,
        colsep=\newcolsep pt,
        #2\relax,
    }
}
{
    \end{longtabs}
}
\newcommand{\multirc}[2]{\SetCell[r=#1\relax,c=#2\relax]{c,m}}
\newcommand{\aux}{\textsc{aux}}
\newcommand{\prefix}{\textsc{prefix}}
\newcommand{\suffix}{\textsc{suffix}}
\newcommand{\conjunction}{\textsc{conjunction}}
\newcommand{\htc}{\textsc{\textbf{HTC}}}
\newcommand{\viteq}{\SetRow{cyan!10}}
\newcommand{\vit}{\SetRow{gray!10}}


% Basic LaTeX structures
\usepackage{enumitem} % For custom enumerate


% Description Labels
% Coutesy of https://tex.stackexchange.com/a/1248
\makeatletter
\let\orgdescriptionlabel\descriptionlabel
\renewcommand*{\descriptionlabel}[1]{%
    \let\orglabel\label
    \let\label\@gobble
    \phantomsection
    \edef\@currentlabel{#1\unskip}%
    %\edef\@currentlabelname{#1}%
    \let\label\orglabel
    \orgdescriptionlabel{#1}%
}
\makeatother


% Miscellaneous
\usepackage{pxrubrica}  % Support for ふりがな
\rubysetup{j}  % Jukugo ruby by default, use | to separate word boundaries if available
\usepackage{siunitx}
\usepackage{nicefrac}
\usepackage{amssymb}  % for \lessapprox
\usepackage{cancel}
\usepackage{centernot}
\usepackage{stmaryrd}  % for \shortrightarrow
\usepackage[math=fp]{datatool-base}  % LaTeX arithmetic courtesy of https://www.dickimaw-books.com/latex/admin/html/arithmetic.shtml
\usepackage{scalefnt}
\usepackage[regular]{newcomputermodern}  % required for scalefnt to work properly and scale character horizontal width; Latin Modern isn't good enough, need New Computer Modern.


% Rename sections for \documentclass{ltjarticle}
% \renewcommand{\figurename}{Figure} % ltjarticle overrides this to ... <not known yet>
\renewcommand{\tablename}{Table} % ltjarticle overrides this to 表 (ひょう)
\renewcommand{\contentsname}{Contents} % ltjarticle overrides this to 表 (ひょう)


% Heading
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\lhead{\textbf{ジャッキー・カン}\\kung.jwe@gmail.com}
\rhead{\textbf{日本語\ruby{学習}{がく|しゅう}\ruby{教材}{きょう|ざい}}}
% \rhead{\textbf{日本語\ruby{学習}{ガク|シュウ}\ruby{教材}{キョウ|ザイ}}}
% Date formatting courtesy of https://tex.stackexchange.com/a/638289
\usepackage{datetime2}
\DTMnewstyle{myformat}{
    \renewcommand*\DTMdisplay[9]{
        \DTMtwodigits{##1}\DTMtwodigits{##2}\DTMtwodigits{##3} \DTMtwodigits{##5}\DTMtwodigits{##6}\DTMtwodigits{##7}
    }
}{}{}{}
\ifcsname currentdatestring\endcsname  % if \currentdatestring is defined (passed from CLI: see Dockerfile)
    \chead{\textlightgrey{\currentdatestring}}
\else
    \chead{\textlightgrey{\DTMsetstyle{myformat} \DTMnow}}
\fi
\setlength{\headheight}{28pt}  % Adjust according to compilation warnings
\cfoot{Page \thepage\ of \pageref{LastPage}}
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\footrulewidth}{0.5pt}
